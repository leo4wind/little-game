<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°´æœæ¶ˆæ¶ˆä¹ (æç¤º+é‡ç½®ç‰ˆ)</title>
    <style>
        /* --- CSS æ ·å¼éƒ¨åˆ† --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation; 
        }

        h2 {
            color: #ff6b6b;
            margin: 10px 0;
            font-size: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .info-panel {
            display: flex;
            gap: 20px;
            align-items: center;
            margin-bottom: 15px;
        }

        .score-board {
            font-size: 1.2rem;
            background: white;
            padding: 8px 20px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            color: #333;
            font-weight: bold;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            font-size: 1rem;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s, opacity 0.2s;
        }
        
        .btn:active { transform: scale(0.95); }
        
        .btn-reset { background-color: #4ecdc4; }
        .btn-hint { background-color: #ffcc5c; color: #333; }
        .btn:disabled { background-color: #ccc; cursor: not-allowed; color: #666; }

        .grid {
            display: flex;
            flex-wrap: wrap;
            width: 360px; /* ç§»åŠ¨ç«¯å‹å¥½å°ºå¯¸: 8åˆ— * 45px */
            height: 360px;
            background-color: #ecc0c0;
            border-radius: 10px;
            padding: 5px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            position: relative;
        }

        .grid div {
            height: 45px;
            width: 45px;
            font-size: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
            transition: transform 0.2s, opacity 0.3s;
            border-radius: 8px;
            box-sizing: border-box;
            z-index: 1;
        }

        .grid div:hover { background-color: rgba(255, 255, 255, 0.3); }
        
        .dragging {
            opacity: 0.5;
            transform: scale(1.2);
            z-index: 10 !important;
        }

        /* æ¶ˆé™¤åŠ¨ç”» */
        .fade-out {
            animation: fadeAndShrink 0.3s forwards;
        }

        /* æç¤ºé«˜äº®åŠ¨ç”» */
        .hint-anim {
            background-color: rgba(255, 255, 255, 0.8) !important;
            box-shadow: 0 0 10px 2px yellow;
            animation: pulse 0.8s infinite alternate;
            z-index: 5;
        }

        @keyframes fadeAndShrink {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        /* æ¡Œé¢ç«¯é€‚é… */
        @media (min-width: 600px) {
            .grid {
                width: 560px; /* 8 * 70 */
                height: 560px;
            }
            .grid div {
                height: 70px;
                width: 70px;
                font-size: 45px;
            }
        }

    </style>
</head>
<body>

    <h2>ğŸ æ°´æœæ¶ˆæ¶ˆä¹ ğŸ‡</h2>
    
    <div class="info-panel">
        <div class="score-board">å¾—åˆ†: <span id="score">0</span></div>
        <div class="controls">
            <button class="btn btn-reset" id="btn-reset">ğŸ”„ é‡ç½®</button>
            <button class="btn btn-hint" id="btn-hint">ğŸ’¡ æç¤º</button>
        </div>
    </div>
    
    <div class="grid"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.querySelector('.grid');
        const scoreDisplay = document.getElementById('score');
        const btnReset = document.getElementById('btn-reset');
        const btnHint = document.getElementById('btn-hint');
        
        const width = 8; 
        const squares = [];
        let score = 0;
        let isProcessing = false; // çŠ¶æ€é”ï¼Œé˜²æ­¢åŠ¨ç”»ä¸­æ“ä½œ

        const fruitColors = ['ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸ“', 'ğŸŠ', 'ğŸ¥¥'];

        // --- åˆå§‹åŒ– ---
        function createBoard() {
            grid.innerHTML = '';
            squares.length = 0; // æ¸…ç©ºæ•°ç»„
            for (let i = 0; i < width * width; i++) {
                const square = document.createElement('div');
                square.setAttribute('draggable', true);
                square.setAttribute('id', i);
                
                // åˆå§‹ç”Ÿæˆæ—¶é¿å…ç›´æ¥å‡ºç°ä¸‰è¿ï¼ˆå¯é€‰ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå…è®¸å¼€å±€æ¶ˆé™¤ï¼‰
                let randomColor = Math.floor(Math.random() * fruitColors.length);
                square.innerHTML = fruitColors[randomColor];
                
                grid.appendChild(square);
                squares.push(square);
                
                // ç»‘å®šäº‹ä»¶
                bindEvents(square);
            }
        }

        function bindEvents(square) {
            // PC
            square.addEventListener('dragstart', dragStart);
            square.addEventListener('dragend', dragEnd);
            square.addEventListener('dragover', e => e.preventDefault());
            square.addEventListener('dragenter', e => e.preventDefault());
            square.addEventListener('drop', dragDrop);
            // Mobile
            square.addEventListener('touchstart', touchStart);
            square.addEventListener('touchmove', touchMove);
            square.addEventListener('touchend', touchEnd);
        }

        createBoard();

        // --- äº¤äº’é€»è¾‘å˜é‡ ---
        let colorBeingDragged, colorBeingReplaced;
        let squareIdBeingDragged, squareIdBeingReplaced;
        let startTouchX, startTouchY;

        // --- PC æ‹–æ‹½ ---
        function dragStart() {
            if(isProcessing) return;
            clearHint(); // å¼€å§‹æ“ä½œæ—¶æ¸…é™¤æç¤º
            colorBeingDragged = this.innerHTML;
            squareIdBeingDragged = parseInt(this.id);
            this.classList.add('dragging');
        }

        function dragDrop() {
            if(isProcessing) return;
            colorBeingReplaced = this.innerHTML;
            squareIdBeingReplaced = parseInt(this.id);
            this.innerHTML = colorBeingDragged;
            squares[squareIdBeingDragged].innerHTML = colorBeingReplaced;
        }

        function dragEnd() {
            if(isProcessing) return;
            this.classList.remove('dragging');
            handleSwapLogic();
        }

        // --- ç§»åŠ¨ç«¯è§¦æ‘¸ ---
        function touchStart(e) {
            if(isProcessing) return;
            e.preventDefault();
            clearHint(); // æ¸…é™¤æç¤º
            startTouchX = e.touches[0].clientX;
            startTouchY = e.touches[0].clientY;
            colorBeingDragged = this.innerHTML;
            squareIdBeingDragged = parseInt(this.id);
            this.classList.add('dragging');
            squareIdBeingReplaced = null;
        }

        function touchMove(e) {
            if(isProcessing) return;
            e.preventDefault();
            if(!startTouchX || !squareIdBeingDragged && squareIdBeingDragged !== 0) return;

            const endTouchX = e.touches[0].clientX;
            const endTouchY = e.touches[0].clientY;
            const diffX = endTouchX - startTouchX;
            const diffY = endTouchY - startTouchY;
            const threshold = 30; // æ»‘åŠ¨çµæ•åº¦

            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > threshold) {
                // å·¦å³
                squareIdBeingReplaced = diffX > 0 ? squareIdBeingDragged + 1 : squareIdBeingDragged - 1;
            } else if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > threshold) {
                // ä¸Šä¸‹
                squareIdBeingReplaced = diffY > 0 ? squareIdBeingDragged + width : squareIdBeingDragged - width;
            }

            if (squareIdBeingReplaced !== null && squares[squareIdBeingReplaced]) {
                // è§†è§‰é¢„è§ˆäº¤æ¢
                colorBeingReplaced = squares[squareIdBeingReplaced].innerHTML;
                squares[squareIdBeingReplaced].innerHTML = colorBeingDragged;
                squares[squareIdBeingDragged].innerHTML = colorBeingReplaced;
                
                squares[squareIdBeingDragged].classList.remove('dragging');
                handleSwapLogic();
                // é‡ç½®é˜²æ­¢è¿ç»­è§¦å‘
                startTouchX = null; 
                startTouchY = null;
            }
        }

        function touchEnd() {
            if (squareIdBeingDragged !== null && squares[squareIdBeingDragged]) {
                squares[squareIdBeingDragged].classList.remove('dragging');
            }
            startTouchX = null;
            startTouchY = null;
        }

        // --- æ ¸å¿ƒäº¤æ¢å¤„ç† ---
        function handleSwapLogic() {
            // æ ¡éªŒç§»åŠ¨åˆæ³•æ€§
            const validMoves = [
                squareIdBeingDragged - 1, squareIdBeingDragged - width,
                squareIdBeingDragged + 1, squareIdBeingDragged + width
            ];
            
            const isValidIndex = (id) => id >= 0 && id < width * width;
            let validMove = validMoves.includes(squareIdBeingReplaced) && isValidIndex(squareIdBeingReplaced);

            // è·¨è¡Œè¾¹ç•Œæ£€æŸ¥
            if (squareIdBeingDragged % width === 0 && squareIdBeingReplaced === squareIdBeingDragged - 1) validMove = false;
            if ((squareIdBeingDragged + 1) % width === 0 && squareIdBeingReplaced === squareIdBeingDragged + 1) validMove = false;

            // æ£€æŸ¥æ˜¯å¦æ¶ˆé™¤
            const isMatch = checkRowForThree(false) || checkColumnForThree(false);

            if (squareIdBeingReplaced && validMove && isMatch) {
                // æˆåŠŸæ¶ˆé™¤ï¼šæ— éœ€æ“ä½œï¼Œç­‰å¾…ä¸»å¾ªç¯å¤„ç†åŠ¨ç”»
                squareIdBeingReplaced = null;
            } else if (squareIdBeingReplaced && validMove) {
                // ç§»åŠ¨åˆæ³•ä½†æ— æ¶ˆé™¤ï¼šæ¢å›å»
                squares[squareIdBeingReplaced].innerHTML = colorBeingReplaced;
                squares[squareIdBeingDragged].innerHTML = colorBeingDragged;
            } else if (squareIdBeingReplaced) {
                // ç§»åŠ¨éæ³•ï¼šæ¢å›å»
                squares[squareIdBeingReplaced].innerHTML = colorBeingReplaced;
                squares[squareIdBeingDragged].innerHTML = colorBeingDragged;
            }
        }

        // --- æ¶ˆé™¤é€»è¾‘ (isRealCheck: true=æ‰§è¡Œæ¶ˆé™¤åŠ åˆ†, false=ä»…æ£€æµ‹) ---
        function checkRowForThree(isRealCheck = true) {
            let matchFound = false;
            for (let i = 0; i < 64; i++) {
                // æ’é™¤æ¯è¡Œæœ€åä¸¤ä¸ª
                if ([6, 7, 14, 15, 22, 23, 30, 31, 38, 39, 46, 47, 54, 55, 62, 63].includes(i)) continue;
                
                let rowOfThree = [i, i + 1, i + 2];
                let decidedColor = squares[i].innerHTML;
                if (decidedColor === '') continue;

                if (rowOfThree.every(index => squares[index].innerHTML === decidedColor)) {
                    if (isRealCheck) {
                        matchFound = true;
                        score += 3;
                        scoreDisplay.innerHTML = score;
                        rowOfThree.forEach(index => {
                            squares[index].classList.add('fade-out');
                            // åŠ¨ç”»ç»“æŸåæ¸…ç†åœ¨ä¸»å¾ªç¯æ§åˆ¶ï¼Œè¿™é‡ŒåªåŠ ç±»
                        });
                    } else {
                        return true; // ä»…æ£€æµ‹
                    }
                }
            }
            return matchFound;
        }

        function checkColumnForThree(isRealCheck = true) {
            let matchFound = false;
            for (let i = 0; i < 48; i++) { // 64 - 16
                let colOfThree = [i, i + width, i + width * 2];
                let decidedColor = squares[i].innerHTML;
                if (decidedColor === '') continue;

                if (colOfThree.every(index => squares[index].innerHTML === decidedColor)) {
                    if (isRealCheck) {
                        matchFound = true;
                        score += 3;
                        scoreDisplay.innerHTML = score;
                        colOfThree.forEach(index => {
                            squares[index].classList.add('fade-out');
                        });
                    } else {
                        return true;
                    }
                }
            }
            return matchFound;
        }

        // --- æ‰è½ä¸å¡«å…… ---
        function moveDown() {
            // ä»å€’æ•°ç¬¬äºŒè¡Œå¾€ä¸Šæ£€æŸ¥
            for (let i = 55; i >= 0; i--) {
                if (squares[i + width].innerHTML === '') {
                    squares[i + width].innerHTML = squares[i].innerHTML;
                    squares[i].innerHTML = '';
                    // å¦‚æœæ­£åœ¨æ‰è½ï¼Œç§»é™¤è¯¥æ ¼å­çš„å¯èƒ½æ®‹ç•™åŠ¨ç”»ç±»
                    squares[i+width].classList.remove('fade-out'); 
                }
            }
            // é¡¶å±‚ç”Ÿæˆ
            for (let i = 0; i < width; i++) {
                if (squares[i].innerHTML === '') {
                    let randomColor = Math.floor(Math.random() * fruitColors.length);
                    squares[i].innerHTML = fruitColors[randomColor];
                    squares[i].classList.remove('fade-out');
                }
            }
        }

        // --- æ¸…ç†åŠ¨ç”»çŠ¶æ€ ---
        function clearFinishedAnimations() {
            const fadingSquares = document.querySelectorAll('.fade-out');
            // å®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦åœ¨åŠ¨ç”»ç»“æŸåæ¸…ç©º innerHTML
            // ä½†ç”±äº moveDown åœ¨ä¸æ–­è¿è¡Œï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œåšä¸€ä¸ªè¾…åŠ©æ¸…ç†
            fadingSquares.forEach(sq => {
                // å¦‚æœ CSS åŠ¨ç”»å·²ç»è·‘å®Œäº†(æˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥ opacity, ä½†ç®€å•ç‚¹ç”¨æ—¶é—´åˆ¤æ–­)
                // è¿™é‡Œæˆ‘ä»¬åˆ©ç”¨ JS å¾ªç¯é¢‘ç‡ï¼šå¦‚æœå®ƒè¢«æ ‡è®°æ¶ˆé™¤ï¼Œå°±å˜ç©º
                if (sq.style.opacity === '0') { // è¿™ç§åˆ¤æ–­ä¸å¯é 
                    sq.innerHTML = '';
                    sq.classList.remove('fade-out');
                }
            });
            
            // æ›´å¥½çš„æ–¹å¼ï¼šç›‘å¬ animationendï¼Œä½†å¦‚æœæ‰¹é‡æ“ä½œï¼Œå®¹æ˜“æ¼
            // æˆ‘ä»¬æ”¹ä¸ºç®€å•æš´åŠ›æ³•ï¼šåœ¨ checkRow/Col é‡Œé¢æ·»åŠ äº† fade-out
            // æˆ‘ä»¬ä½¿ç”¨ setTimeout åœ¨ 300ms åæ¸…ç©ºå†…å®¹
            // (è¿™éƒ¨åˆ†é€»è¾‘ç¨å¾®è°ƒæ•´ä¸€ä¸‹ï¼Œä¸ºäº†é˜²æ­¢é—ªçƒï¼Œæˆ‘ä»¬åœ¨ check é‡Œå·²ç»åšäº† class add)
        }
        
        // ä¿®æ­£æ¶ˆé™¤çš„åç»­å¤„ç†
        // ç”±äº setInterval å¾ˆå¿«ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ ‡å¿—ä½
        function processMatches() {
            const matches = document.querySelectorAll('.fade-out');
            if (matches.length > 0) {
                isProcessing = true;
                setTimeout(() => {
                    matches.forEach(sq => {
                        sq.innerHTML = '';
                        sq.classList.remove('fade-out');
                    });
                    isProcessing = false;
                }, 300); // å¯¹åº” CSS 0.3s åŠ¨ç”»
            }
        }

        // --- åŠŸèƒ½æŒ‰é’®é€»è¾‘ ---

        // 1. é‡ç½®æ¸¸æˆ (åˆ†æ•°ä¸å˜)
        btnReset.addEventListener('click', () => {
            clearHint();
            // ç®€å•çš„æ´—ç‰ŒåŠ¨ç”»
            squares.forEach(sq => {
                sq.innerHTML = '';
                sq.classList.add('fade-out');
            });
            
            setTimeout(() => {
                squares.forEach(sq => sq.classList.remove('fade-out'));
                createBoard(); // é‡æ–°ç”Ÿæˆ
            }, 300);
        });

        // 2. æç¤ºåŠŸèƒ½
        function clearHint() {
            squares.forEach(sq => sq.classList.remove('hint-anim'));
        }

        // è¾…åŠ©ï¼šè™šæ‹Ÿæ£€æŸ¥äº¤æ¢åæ˜¯å¦æœ‰æ•ˆ
        function isValidSwap(idx1, idx2) {
            // å¤‡ä»½é¢œè‰²
            const c1 = squares[idx1].innerHTML;
            const c2 = squares[idx2].innerHTML;
            if(!c1 || !c2) return false;

            // äº¤æ¢
            squares[idx1].innerHTML = c2;
            squares[idx2].innerHTML = c1;

            // æ£€æŸ¥æ˜¯å¦åŒ¹é… (å¤ç”¨ check å‡½æ•°çš„é€»è¾‘ï¼Œä½†ä¸åŠ åˆ†)
            // è¿™é‡Œä¸èƒ½ç›´æ¥è°ƒå…¨å±€ checkRowForThree(false)ï¼Œå› ä¸ºå®ƒæ£€æŸ¥å…¨ç›˜ï¼Œæ•ˆç‡ä½ä¸”å¯èƒ½è¯¯åˆ¤å…¶ä»–ä½ç½®
            // æˆ‘ä»¬å†™ä¸ªç®€å•çš„å±€éƒ¨æ£€æŸ¥
            let match = false;
            if (checkLocalMatch(idx1) || checkLocalMatch(idx2)) match = true;

            // è¿˜åŸ
            squares[idx1].innerHTML = c1;
            squares[idx2].innerHTML = c2;

            return match;
        }

        function checkLocalMatch(idx) {
            // ç®€å•æ£€æŸ¥è¯¥ç‚¹æ¨ªçºµ
            const r = Math.floor(idx/width);
            const c = idx % width;
            const color = squares[idx].innerHTML;

            // æ¨ªå‘
            let h = 1; 
            if(c>0 && squares[idx-1].innerHTML === color) { h++; if(c>1 && squares[idx-2].innerHTML===color) h++; }
            if(c<width-1 && squares[idx+1].innerHTML === color) { h++; if(c<width-2 && squares[idx+2].innerHTML===color) h++; }
            // éœ€è¦ç¨å¾®ç²¾ç»†ç‚¹çš„é€»è¾‘ï¼Œè¿™é‡Œç®€åŒ–ï¼šåªè¦æ¨ªå‘æˆ–çºµå‘èƒ½è¿3ä¸ª
            // é‡æ–°å…¨ç›˜æ‰«æä¸€æ¬¡å…¶å®å¯¹äº 8x8 å¾ˆå¿«ï¼Œä¸ºäº†å‡†ç¡®ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨å…¨ç›˜æ‰«æ(éç ´åæ€§)
            return checkRowForThree(false) || checkColumnForThree(false);
        }

        btnHint.addEventListener('click', () => {
            clearHint();
            if(isProcessing) return;

            // å¯»æ‰¾ä¸€ä¸ªå¯è¡Œçš„äº¤æ¢
            let found = false;
            for(let i=0; i<width*width; i++) {
                // å°è¯•å³äº¤æ¢
                if((i+1)%width !== 0) {
                    if(isValidSwap(i, i+1)) {
                        squares[i].classList.add('hint-anim');
                        squares[i+1].classList.add('hint-anim');
                        found = true;
                        break;
                    }
                }
                // å°è¯•ä¸‹äº¤æ¢
                if(i+width < width*width) {
                    if(isValidSwap(i, i+width)) {
                        squares[i].classList.add('hint-anim');
                        squares[i+width].classList.add('hint-anim');
                        found = true;
                        break;
                    }
                }
            }
            
            if(!found) {
                alert('å½“å‰æ²¡æœ‰å¯æ¶ˆé™¤çš„ç»„åˆï¼Œè¯·ç‚¹å‡»é‡ç½®ï¼');
            } else {
                // 3ç§’åè‡ªåŠ¨å–æ¶ˆæç¤º
                setTimeout(clearHint, 3000);
            }
        });


        // --- æ¸¸æˆä¸»å¾ªç¯ ---
        window.setInterval(() => {
            // å¦‚æœæœ‰æ­£åœ¨æ¶ˆå¤±çš„ï¼Œä¸è¿›è¡Œç‰©ç†æ‰è½
            const isAnimating = document.querySelectorAll('.fade-out').length > 0;
            
            if (!isAnimating) {
                moveDown();
                
                // åªæœ‰åœ¨é™æ­¢æ—¶æ‰è¿›è¡ŒçœŸå®çš„æ¶ˆé™¤æ£€æŸ¥
                const m1 = checkRowForThree(true);
                const m2 = checkColumnForThree(true);
                
                if (m1 || m2) {
                    processMatches();
                }
            }
        }, 100);
    });
</script>
</body>
</html>
