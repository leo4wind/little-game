<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¯å‰ç«¯åå®¹é“</title>
    <style>
        /* --- CSS æ ·å¼éƒ¨åˆ† --- */
        body {
            font-family: 'SimHei', 'Arial', sans-serif;
            background: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .info {
            font-size: 1.2rem;
            margin-bottom: 20px;
            color: #666;
            display: flex;
            gap: 20px;
        }

        .info button {
            padding: 5px 15px;
            font-size: 1rem;
            border: none;
            background: #5B92E5;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .info button:hover {
            background: #4a7fd3;
        }

        /* æ£‹ç›˜å®¹å™¨ */
        .board-container {
            position: relative;
            background: #8B4513;
            /* åœŸæ£•è‰² */
            padding: 10px;
            border: 10px solid #4a280e;
            border-radius: 10px;
        }

        /* CSS Grid å¸ƒå±€ï¼š4åˆ— x 5è¡Œ */
        .board {
            display: grid;
            grid-template-columns: repeat(4, 80px);
            /* 4 åˆ—ï¼Œæ¯åˆ— 80px */
            grid-template-rows: repeat(5, 80px);
            /* 5 è¡Œï¼Œæ¯è¡Œ 80px */
            gap: 5px;
            /* æ£‹å­ä¹‹é—´çš„é—´éš™ */
            position: relative;
        }

        /* æ£‹å­åŸºç¡€æ ·å¼ */
        .piece {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-size: 1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.15s ease-out;
            /* ç§»åŠ¨åŠ¨ç”» */
            position: absolute;
            /* ä½¿ pieces å¯ä»¥è„±ç¦» flow ä½¿ç”¨ top/left/width/height */
        }

        /* æ›¹æ“ (2x2) */
        .boss {
            background-color: #B30000;
            z-index: 5;
        }

        /* å…³ç¾½ (2x1 æ¨ª) */
        .horizontal {
            background-color: #FF7373;
        }

        /* å¼ é£ç­‰ (1x2 ç«–) */
        .vertical {
            background-color: #5B92E5;
        }

        /* å°å…µ (1x1) */
        .soldier {
            background-color: #97CC70;
        }

        /* è·èƒœæç¤º */
        .win-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            border-radius: 10px;
            z-index: 10;
        }

        .win-overlay.active {
            display: flex;
        }

        /* åº•éƒ¨å‡ºå£ */
        .exit-marker {
            position: absolute;
            bottom: -5px;
            /* è°ƒæ•´åˆ°æ¿å­åº•éƒ¨ */
            left: 50%;
            transform: translateX(-50%);
            width: 165px;
            /* 2åˆ— + 1é—´éš™ */
            height: 10px;
            background: #3c2415;
            z-index: 0;
            border-radius: 0 0 5px 5px;
        }

        /* åª’ä½“æŸ¥è¯¢ï¼šå°å±å¹•é€‚é… */
        @media (max-width: 400px) {
            .board {
                grid-template-columns: repeat(4, 60px);
                grid-template-rows: repeat(5, 60px);
                gap: 4px;
            }

            .info {
                font-size: 1rem;
            }

            .piece {
                font-size: 0.8rem;
            }

            .exit-marker {
                width: 124px;
            }
        }
    </style>
</head>

<body>

    <h1>ğŸ® åå®¹é“ ğŸ®</h1>

    <div class="info">
        <div id="move-counter">æ­¥æ•°: 0</div>
        <button onclick="resetGame()">é‡ç½®</button>
    </div>

    <div class="board-container">
        <div class="board" id="game-board">
        </div>
        <div class="exit-marker"></div>

        <div class="win-overlay" id="win-message">
            ğŸ‰ æˆåŠŸé€ƒè„±ï¼ ğŸ‰
            <button onclick="resetGame()" style="margin-top: 20px; font-size: 1.2rem;">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <script>
        const GRID_SIZE = 80;
        const GAP = 5;
        const ROWS = 5;
        const COLS = 4;

        const boardElement = document.getElementById('game-board');
        const moveCounter = document.getElementById('move-counter');
        const winMessage = document.getElementById('win-message');

        let moves = 0;

        const initialPiecesConfig = [
            { id: 'CC', w: 2, h: 2, r: 0, c: 1, name: 'æ›¹æ“', class: 'boss' },
            { id: 'ZF', w: 1, h: 2, r: 0, c: 0, name: 'å¼ é£', class: 'vertical' },
            { id: 'ZY', w: 1, h: 2, r: 0, c: 3, name: 'èµµäº‘', class: 'vertical' },
            { id: 'GY', w: 2, h: 1, r: 2, c: 1, name: 'å…³ç¾½', class: 'horizontal' },
            { id: 'MC', w: 1, h: 2, r: 2, c: 0, name: 'é©¬è¶…', class: 'vertical' },
            { id: 'HZ', w: 1, h: 2, r: 2, c: 3, name: 'é»„å¿ ', class: 'vertical' },
            { id: 'S1', w: 1, h: 1, r: 3, c: 1, name: 'å’1', class: 'soldier' },
            { id: 'S2', w: 1, h: 1, r: 3, c: 2, name: 'å’2', class: 'soldier' },
        ];

        let pieces = [];
        let boardState = [];

        // --- æ‹–æ‹½ç›¸å…³çŠ¶æ€ ---
        let activePiece = null;
        let dragStartX = 0;
        let dragStartY = 0;

        // --- 1. æ¸¸æˆåˆå§‹åŒ–å’Œé‡ç½® ---
        function resetGame() {
            pieces = initialPiecesConfig.map(p => ({ ...p }));
            moves = 0;
            moveCounter.textContent = `æ­¥æ•°: ${moves}`;
            winMessage.classList.remove('active');
            boardElement.innerHTML = '';
            activePiece = null; // é‡ç½®æ‹–æ‹½çŠ¶æ€

            createPiecesElements();
            updateBoardState();
            renderBoard();
        }

        function createPiecesElements() {
            pieces.forEach(piece => {
                let div = document.createElement('div');
                div.className = `piece ${piece.class}`;
                div.id = `piece-${piece.id}`;
                div.textContent = piece.name;
                div.pieceId = piece.id;

                // ç»‘å®šæ‹–æ‹½å¼€å§‹äº‹ä»¶ (æ›¿ä»£åŸæ¥çš„ click)
                div.addEventListener('mousedown', handleMouseDown);
                // å…¼å®¹ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
                div.addEventListener('touchstart', handleTouchStart, { passive: false });

                boardElement.appendChild(div);
            });
        }

        // --- 2. çŠ¶æ€ç®¡ç† ---

        function updateBoardState() {
            boardState = Array(ROWS).fill(0).map(() => Array(COLS).fill(0));
            pieces.forEach(p => {
                for (let r = p.r; r < p.r + p.h; r++) {
                    for (let c = p.c; c < p.c + p.w; c++) {
                        if (r < ROWS && c < COLS) {
                            boardState[r][c] = p.id;
                        }
                    }
                }
            });
        }

        function renderBoard() {
            pieces.forEach(p => {
                const el = document.getElementById(`piece-${p.id}`);
                if (el) {
                    // åƒç´ è®¡ç®—
                    const totalWidth = p.w * GRID_SIZE + (p.w - 1) * GAP;
                    const totalHeight = p.h * GRID_SIZE + (p.h - 1) * GAP;
                    const totalLeft = p.c * GRID_SIZE + p.c * GAP;
                    const totalTop = p.r * GRID_SIZE + p.r * GAP;

                    el.style.width = `${totalWidth}px`;
                    el.style.height = `${totalHeight}px`;
                    el.style.left = `${totalLeft}px`;
                    el.style.top = `${totalTop}px`;
                }
            });
        }

        // --- 3. ç§»åŠ¨é€»è¾‘ (å¤ç”¨) ---
        function isAreaEmpty(pieceId, newR, newC, w, h) {
            if (newR < 0 || newC < 0 || newR + h > ROWS || newC + w > COLS) {
                return false;
            }
            for (let r = newR; r < newR + h; r++) {
                for (let c = newC; c < newC + w; c++) {
                    const cellContent = boardState[r][c];
                    if (cellContent !== 0 && cellContent !== pieceId) {
                        return false;
                    }
                }
            }
            return true;
        }

        // --- 4. æ‹–æ‹½å¤„ç† ---

        // PC ç«¯
        function handleMouseDown(e) {
            if (winMessage.classList.contains('active')) return;

            const pieceEl = e.currentTarget;
            const pieceId = pieceEl.pieceId;

            activePiece = pieces.find(p => p.id === pieceId);
            if (!activePiece) return;

            // è®°å½•é¼ æ ‡èµ·å§‹ç‚¹
            dragStartX = e.clientX;
            dragStartY = e.clientY;

            // ç»‘å®šå…¨å±€äº‹ä»¶
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);

            // è§†è§‰åé¦ˆ
            pieceEl.style.zIndex = 100;
            pieceEl.style.cursor = 'grabbing';
        }

        function handleMouseMove(e) {
            if (!activePiece) return;
            const pieceEl = document.getElementById(`piece-${activePiece.id}`);
            if (!pieceEl) return;

            // å®æ—¶è·Ÿéšé¼ æ ‡ï¼Œä½†åªå…è®¸æ²¿ä¸€ä¸ªè½´ç§»åŠ¨
            const dx = e.clientX - dragStartX;
            const dy = e.clientY - dragStartY;

            // è·å–æ£‹å­å½“å‰çš„ CSS åæ ‡
            const currentLeft = activePiece.c * GRID_SIZE + activePiece.c * GAP;
            const currentTop = activePiece.r * GRID_SIZE + activePiece.r * GAP;

            if (activePiece.w > 1 && activePiece.h > 1) {
                // æ›¹æ“ (2x2) å¯ä»¥æ¨ªç«–éƒ½èµ°ï¼Œçœ‹æ‹–æ‹½è½´
                if (Math.abs(dx) > Math.abs(dy)) {
                    // æ°´å¹³æ‹–æ‹½
                    pieceEl.style.left = `${currentLeft + dx}px`;
                    pieceEl.style.top = `${currentTop}px`;
                } else {
                    // å‚ç›´æ‹–æ‹½
                    pieceEl.style.left = `${currentLeft}px`;
                    pieceEl.style.top = `${currentTop + dy}px`;
                }
            } else if (activePiece.w > 1) {
                // å…³ç¾½ (æ¨ªå‘ 2x1) åªèƒ½æ°´å¹³æ‹–æ‹½
                pieceEl.style.left = `${currentLeft + dx}px`;
                pieceEl.style.top = `${currentTop}px`;
            } else if (activePiece.h > 1) {
                // å¼ é£ç­‰ (å‚ç›´ 1x2) åªèƒ½å‚ç›´æ‹–æ‹½
                pieceEl.style.left = `${currentLeft}px`;
                pieceEl.style.top = `${currentTop + dy}px`;
            } else {
                // å’ (1x1) çœ‹æ‹–æ‹½è½´
                if (Math.abs(dx) > Math.abs(dy)) {
                    pieceEl.style.left = `${currentLeft + dx}px`;
                    pieceEl.style.top = `${currentTop}px`;
                } else {
                    pieceEl.style.left = `${currentLeft}px`;
                    pieceEl.style.top = `${currentTop + dy}px`;
                }
            }
        }

        function handleMouseUp(e) {
            if (!activePiece) return;

            // è§£ç»‘å…¨å±€äº‹ä»¶
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);

            const pieceEl = document.getElementById(`piece-${activePiece.id}`);
            pieceEl.style.zIndex = '';
            pieceEl.style.cursor = 'pointer';

            const dx = e.clientX - dragStartX;
            const dy = e.clientY - dragStartY;

            // ç¡®å®šç§»åŠ¨æ–¹å‘å’Œæ­¥æ•°
            let steps = 0;
            let dr = 0;
            let dc = 0;
            const threshold = (GRID_SIZE + GAP) / 2; // ç§»åŠ¨è¶…è¿‡åŠä¸ªæ ¼å­ç®—ä½œä¸€æ­¥

            if (Math.abs(dx) > Math.abs(dy)) {
                // æ°´å¹³ç§»åŠ¨
                steps = Math.round(dx / (GRID_SIZE + GAP));
                dc = steps;
            } else {
                // å‚ç›´ç§»åŠ¨
                steps = Math.round(dy / (GRID_SIZE + GAP));
                dr = steps;
            }

            if (steps !== 0) {
                // è®¡ç®—ç›®æ ‡ä½ç½®
                const newR = activePiece.r + dr;
                const newC = activePiece.c + dc;

                // æ£€æŸ¥ç›®æ ‡ä½ç½®æ˜¯å¦å¯è¡Œï¼ˆéœ€è¦æ£€æŸ¥æ‰€æœ‰æ­¥é•¿æ˜¯å¦å¯è¡Œï¼Œè¿™é‡Œç®€åŒ–ï¼šåªæ£€æŸ¥æœ€ç»ˆç›®æ ‡ï¼‰
                if (isAreaEmpty(activePiece.id, newR, newC, activePiece.w, activePiece.h)) {
                    // æ‰§è¡Œç§»åŠ¨
                    activePiece.r = newR;
                    activePiece.c = newC;
                    moves++;
                    moveCounter.textContent = `æ­¥æ•°: ${moves}`;
                    updateBoardState();
                    checkWinCondition();
                }
            }

            // æ— è®ºæ˜¯å¦ç§»åŠ¨æˆåŠŸï¼Œéƒ½é‡æ–°æ¸²æŸ“ï¼Œè®©æ£‹å­å›åˆ°æ­£ç¡®çš„ç½‘æ ¼ä½ç½® (æˆ–æ–°ä½ç½®)
            renderBoard();
            activePiece = null;
        }

        // ç§»åŠ¨ç«¯å…¼å®¹
        function getTouchCoords(e) {
            const touch = e.touches[0] || e.changedTouches[0];
            return { clientX: touch.clientX, clientY: touch.clientY };
        }

        function handleTouchStart(e) {
            e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
            const coords = getTouchCoords(e);
            // æ¨¡æ‹Ÿ mousedown
            handleMouseDown({
                clientX: coords.clientX,
                clientY: coords.clientY,
                currentTarget: e.currentTarget
            });
            document.addEventListener('touchmove', handleTouchMove, { passive: false });
            document.addEventListener('touchend', handleTouchEnd);
        }

        function handleTouchMove(e) {
            e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
            const coords = getTouchCoords(e);
            // æ¨¡æ‹Ÿ mousemove
            handleMouseMove({ clientX: coords.clientX, clientY: coords.clientY });
        }

        function handleTouchEnd(e) {
            const coords = getTouchCoords(e);
            // æ¨¡æ‹Ÿ mouseup
            handleMouseUp({ clientX: coords.clientX, clientY: coords.clientY });
            document.removeEventListener('touchmove', handleTouchMove);
            document.removeEventListener('touchend', handleTouchEnd);
        }

        // --- 4. èƒœåˆ©æ¡ä»¶ (ä¸å˜) ---
        function checkWinCondition() {
            const caoCao = pieces.find(p => p.id === 'CC');
            if (caoCao && caoCao.r === 3 && caoCao.c === 1) {
                winMessage.classList.add('active');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåï¼Œå¯åŠ¨æ¸¸æˆ
        resetGame();
    </script>
</body>

</html>
